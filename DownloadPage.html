<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NHP SecureLocker - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</title>
  <!-- NHPãƒ­ã‚´ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ï¼ˆæä¾›ã•ã‚ŒãŸSVGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³åŸ‹ã‚è¾¼ã¿ï¼‰ -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 320'%3E%3Cpath fill='%23000' d='M187 321h-186V1h320v320h-134m96.814-6.07c4.443-1.52 9.378-2.263 13.235-4.708 10.535-6.678 16.308-16.42 16.83-29.69.04-.497.113-.994.113-1.492.007-78.48.012-156.96-.026-235.44 0-1.196-.531-2.392-.951-4.461-.044-1.825.242-3.755-.241-5.458C308.057 17 295.8 6.056 277.434 6.037 198.183 5.956 118.933 5.996 39.682 6.007c-19.928.003-34.464 13.846-35.557 33.458-.04.497-.117.995-.117 1.492-.007 79.15-.012 158.299.026 237.448 0 1.196.534 2.392.952 4.462 1.665 5.535 2.477 11.534 5.181 16.505 4.984 9.162 13.615 13.767 24.733 15.636 80.216.8 160.433.803 240.65-.004 2.492 0 4.985-.095 8.263-.062z'/%3E%3Cpath fill='%23007EC5' d='M313.15 280.988c.206 12.814-5.567 22.556-16.102 29.234-3.856 2.445-8.791 3.19-13.985 4.455-2.565-.394-4.378-.656-6.191-.656-79.029-.021-158.058-.025-237.088.016-1.94 0-3.879.526-5.818.807-10.183-1.716-18.813-6.32-23.797-15.483-2.704-4.97-3.516-10.97-5.198-17.403-.005-73.598.01-146.299.012-219 0-7.984-.084-15.967-.128-23.95C5.218 19.853 19.754 6.01 39.682 6.007c79.25-.012 158.501-.05 237.751.03 18.366.019 30.624 10.961 35.359 27.653.483 1.703.166 3.633.239 6.355.007 72.264-.01 143.631-.01 215.005 0 8.649.084 17.297.129 25.946M210.636 110.713c-.212 1.459-.607 2.918-.608 4.378-.036 30.034-.042 60.069.012 90.103.003 1.601.578 3.201 1.521 5.377 4.405 0 8.81 0 13.566 0 0-7.287 0-14.418 0-21.548 0-7.249 0-14.498 0-21.962 15.261 0 29.735.023 44.209-.006 15.908-.032 28.363-12.43 28.551-28.363.182-15.474-12.702-28.605-28.342-28.67-19.478-.079-38.956.004-58.909.69M20.132 209.773c4.564.562 9.128 1.123 14.117 1.737 0-26.953 0-52.694 0-79.473 1.32 1.606 2.059 2.385 2.664 3.256 16.17 23.3 32.328 46.609 48.484 69.919 3.22 4.644 7.43 6.526 11.706 5.204 5.246-1.622 6.891-4.105 6.893-10.557.01-28.331.004-56.662.004-84.993 0-1.58 0-3.158 0-4.866-3.433 0-6.122.233-8.754-.054-4.076-.445-5.414.917-5.375 5.185.209 22.83.099 45.662.099 68.494 0 1.57 0 3.14 0 5.763-17.447-25.004-34.247-48.997-50.929-73.072-2.758-3.98-6.083-6.797-11.033-6.204-4.986.597-7.066 4.438-8.546 9.631-.151.98-.434 1.961-.435 2.942-.026 27.318-.036 54.635.008 81.953.002 1.451.521 2.901 1.093 5.136M128.275 111.669c-3.33-.556-6.644-1.252-9.993-1.63-3.83-.434-5.385.994-5.361 5.116.155 27.48.08 54.96.08 82.44 0 13.75 0 13.752 13.979 13.117.29-.014.568-.279 1.454-.741 0-14.076 0-28.468 0-42.765 19.84 0 39.072 0 58.653 0 0 14.608 0 28.872 0 43.603 3.123 0 5.934-.232 8.69.055 4.085.426 5.405-.989 5.38-5.237-.176-30.477-.09-60.956-.106-91.434 0-1.422-.18-2.843-.261-4.026-4.883 0-9.281 0-13.973 0 0 14.326 0 28.262 0 42.35-19.544 0-38.77 0-58.504 0-.037-13.536-.037-26.82-.074-41.075z'/%3E%3Cpath fill='%23228ECC' d='M34.433 314.92c1.471-.357 3.41-.883 5.35-.884 79.029-.04 158.058-.037 237.088-.015 1.813 0 3.626.262 4.798.615-2.134.263-4.627.358-7.119.358-80.217.007-160.433.005-241.117-.074z'/%3E%3Cpath fill='%2390C6E4' d='M4.49 39.237c.408 7.755.492 15.739.492 23.722 0 72.7-.016 145.4-.077 218.567-.335-.73-.869-1.926-.87-3.122C3.998 199.255 4.003 120.106 4.01 40.957c0-.497.076-.995.48-1.72z'/%3E%3Cpath fill='%2398CAE7' d='M313.514 280.76c-.409-8.421-.493-17.07-.493-25.718 0-71.367.017-142.733.078-214.565.334.73.864 1.927.865 3.123.037 78.48.032 156.96.026 235.44 0 .497-.074.995-.476 1.72z'/%3E%3Cpath fill='%23FEFFFF' d='M19.838 119.011c1.106-4.462 3.186-8.303 8.172-8.9 4.95-.593 8.275 2.224 11.033 6.205 16.682 24.074 33.482 48.068 50.929 73.072 0-2.624 0-4.193 0-5.763 0-22.832.11-45.663-.1-68.494-.039-4.268 1.299-5.63 5.375-5.185 2.632.287 5.321.054 8.754.054 0 1.58 0 3.159 0 4.866 0 28.331.005 56.662-.005 84.993-.002 6.452-1.647 8.935-6.893 10.557-4.276 1.322-8.487-.56-11.706-5.204-16.156-23.31-32.314-46.62-48.484-69.92-.605-.87-1.344-1.65-2.664-3.255 0 26.779 0 52.52 0 79.473-4.989-.614-9.553-1.175-14.117-2.593-.124-30.539-.17-60.223-.216-89.906z'/%3E%3Cpath fill='%23FFF' d='M128.294 112.154c.018 13.77.018 27.053.018 40.59 19.735 0 44.96 0 58.504 0 0-14.088 0-28.024 0-42.35 4.692 0 9.09 0 13.973 0 .08 1.183.26 2.604.261 4.026.016 30.478-.07 60.957.106 91.434.025 4.248-1.295 5.663-5.38 5.237-2.756-.287-5.567-.055-8.69-.055 0-14.731 0-28.995 0-43.603-19.581 0-38.813 0-58.653 0 0 14.297 0 28.689 0 42.765-.886.461-1.164.727-1.454.741C113 210.824 113 210.821 113 197.072c0-27.48.075-54.96-.08-82.44-.024-4.122 1.531-5.55 5.361-5.116 3.35.378 6.663 1.074 9.993 1.63z'/%3E%3Cpath fill='%23FEFFFF' d='M211.112 110.039c19.479-.014 38.957-.097 58.435-.016 15.64.064 28.524 13.195 28.342 28.67-.188 15.933-12.643 28.33-28.55 28.362-14.475.03-28.948.007-44.21.007 0 7.464 0 14.713 0 21.962 0 7.13 0 14.261 0 21.548-4.756 0-9.161 0-13.853-.756-.246-33.762-.205-66.77-.164-99.777m13.011 39.221c-.561 3.222.927 3.832 3.842 3.803 13.63-.133 27.262-.03 40.894-.07 7.91-.022 13.81-6.263 13.79-14.462-.02-8.22-5.84-14.414-13.825-14.459-13.798-.079-27.596-.035-41.394-.003-1.084.003-2.167.315-3.307.508 0 8.119 0 15.924 0 24.683z'/%3E%3Cpath fill='%230072BF' d='M210.874 110.376c.04 32.67 0 65.676-.04 99.15-.339-1.132-.914-2.733-.917-4.333-.053-30.035-.048-60.07-.012-90.104.001-1.46.396-2.919.846-4.714z'/%3E%3Cpath fill='%230074C0' d='M19.651 119.377c.046 29.318.092 63.001.068 96.148-.348-.987-.867-2.437-.869-3.888-.046-27.318-.036-54.635.029-81.953 0-.98.283-1.961.434-2.942z'/%3E%3Cpath fill='%23037FC5' d='M225.123 148.782c0-8.282 0-16.087 0-24.206 1.241-.193 2.324-.506 3.408-.508 13.798-.032 27.596-.076 41.394.003 7.985.045 13.805 6.239 13.825 14.46.02 8.198-5.88 14.44-13.79 14.461-13.632.04-27.264-.057-40.894.07-2.915.029-4.403-.581-3.842-3.803z'/%3E%3C/svg%3E">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #0075c1 0%, #005a9e 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 100%;
      padding: 40px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo {
      font-size: 32px;
      font-weight: 700;
      color: #0075c1;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
    }

    .section {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: #0075c1;
      margin-right: 10px;
      border-radius: 2px;
    }

    .file-list {
      background: #f7f9fc;
      border-radius: 8px;
      padding: 15px;
    }

    .file-item {
      display: flex;
      align-items: center;
      padding: 10px;
      background: white;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .file-item:last-child {
      margin-bottom: 0;
    }

    .file-icon {
      width: 40px;
      height: 40px;
      background: #e3f2fd;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      font-size: 20px;
    }

    .file-info {
      flex: 1;
    }

    .file-name {
      font-weight: 500;
      color: #333;
      font-size: 14px;
    }

    .file-size {
      color: #999;
      font-size: 12px;
      margin-top: 2px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 500;
      color: #333;
      margin-bottom: 8px;
      font-size: 14px;
    }

    input[type="email"],
    input[type="text"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }

    input[type="email"]:focus,
    input[type="text"]:focus {
      outline: none;
      border-color: #0075c1;
      box-shadow: 0 0 0 3px rgba(0, 117, 193, 0.15);
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, #0075c1 0%, #0094d9 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(0, 117, 193, 0.25);
    }

    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #005a9e 0%, #0075c1 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 117, 193, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #00a859 0%, #00c768 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(0, 168, 89, 0.25);
    }

    .btn-success:hover:not(:disabled) {
      background: linear-gradient(135deg, #008a47 0%, #00a859 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 168, 89, 0.4);
    }

    .btn:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .alert-info {
      background: #e3f2fd;
      color: #01579b;
      border-left: 4px solid #0075c1;
    }

    .alert-success {
      background: #e8f5e9;
      color: #1b5e20;
      border-left: 4px solid #00a859;
    }

    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border-left: 4px solid #ef4444;
    }

    .expiry-info {
      text-align: center;
      color: #666;
      font-size: 13px;
      padding: 12px;
      background: #f7f9fc;
      border-radius: 8px;
      margin-top: 20px;
    }

    .step {
      display: none;
    }

    .step.active {
      display: block;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0075c1;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">ğŸ”’ NHP SecureLocker</div>
      <div class="subtitle">å®‰å…¨ãªãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</div>
    </div>

    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ -->
    <div class="section">
      <div class="section-title">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ãªãƒ•ã‚¡ã‚¤ãƒ«</div>
      <div class="file-list" id="fileList">
        <?
          for (var i = 0; i < files.length; i++) {
            var file = files[i];
            var sizeKB = (file.size / 1024).toFixed(1);
        ?>
        <div class="file-item">
          <div class="file-icon">ğŸ“„</div>
          <div class="file-info">
            <div class="file-name"><?= file.originalName ?></div>
            <div class="file-size"><?= sizeKB ?> KB</div>
          </div>
        </div>
        <? } ?>
      </div>
    </div>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ› -->
    <div class="step active" id="step1">
      <div class="alert alert-info">
        ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯ã€é€ä¿¡å…ˆã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
      </div>

      <div class="form-group">
        <label for="emailInput">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="email" id="emailInput" placeholder="your.email@example.com" required>
      </div>

      <button class="btn btn-primary" id="requestPasswordBtn" onclick="requestPassword()">
        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç™ºè¡Œ
      </button>
    </div>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ› -->
    <div class="step" id="step2">
      <div class="alert alert-success" id="passwordSentMessage"></div>

      <div class="form-group">
        <label for="passwordInput">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ24æ¡ï¼‰</label>
        <input type="text" id="passwordInput" placeholder="ãƒ¡ãƒ¼ãƒ«ã«é€ä¿¡ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" maxlength="24">
      </div>

      <button class="btn btn-primary" id="verifyPasswordBtn" onclick="verifyPassword()">
        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç¢ºèª
      </button>

      <div style="text-align: center; margin-top: 15px;">
        <a href="#" onclick="backToStep1(); return false;" style="color: #0075c1; font-size: 14px; text-decoration: none; font-weight: 500;">â† æˆ»ã‚‹</a>
      </div>
    </div>

    <!-- ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
    <div class="step" id="step3">
      <div class="alert alert-success">
        âœ“ èªè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã§ãã¾ã™ã€‚
      </div>

      <button class="btn btn-success" id="downloadBtn" onclick="downloadFiles()">
        ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      </button>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div>å‡¦ç†ä¸­...</div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
    <div class="alert alert-error hidden" id="errorMessage"></div>

    <!-- æœ‰åŠ¹æœŸé™è¡¨ç¤º -->
    <div class="expiry-info">
      æœ‰åŠ¹æœŸé™: <?= expiryAt ?>
    </div>
  </div>

  <script>
    var trackingId = '<?= trackingId ?>';
    var passwordKey = null;

    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
      document.querySelectorAll('.btn').forEach(btn => btn.disabled = show);
    }

    function showError(message) {
      var errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => errorDiv.classList.add('hidden'), 5000);
    }

    function showStep(stepNumber) {
      document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
      document.getElementById('step' + stepNumber).classList.add('active');
    }

    function backToStep1() {
      showStep(1);
      document.getElementById('emailInput').value = '';
      document.getElementById('passwordInput').value = '';
      passwordKey = null;
    }

    function requestPassword() {
      var email = document.getElementById('emailInput').value.trim();

      if (!email) {
        showError('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        showError('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      showLoading(true);

      google.script.run
        .withSuccessHandler(function(response) {
          showLoading(false);

          if (response.success) {
            passwordKey = response.passwordKey;
            document.getElementById('passwordSentMessage').textContent = response.message;
            showStep(2);
          } else {
            showError(response.message);
          }
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        })
        .handleVerifyEmailFromClient(trackingId, email);
    }

    function verifyPassword() {
      var password = document.getElementById('passwordInput').value.trim();

      if (!password) {
        showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (password.length !== 24) {
        showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯24æ¡ã§ã™');
        return;
      }

      showLoading(true);

      google.script.run
        .withSuccessHandler(function(response) {
          showLoading(false);

          if (response.success) {
            showStep(3);
          } else {
            showError(response.message);
          }
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        })
        .handleVerifyPasswordFromClient(passwordKey, password);
    }

    function downloadFiles() {
      showLoading(true);

      google.script.run
        .withSuccessHandler(function(response) {
          showLoading(false);

          if (response.success) {
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL ã«é·ç§»
            window.location.href = response.downloadUrl;

            // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            setTimeout(function() {
              alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚\nã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚');
            }, 500);
          } else {
            showError(response.message);
          }
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        })
        .handleDownloadFromClient(trackingId, passwordKey);
    }
  </script>
</body>
</html>

<? const brand = this.brand; const tid = this.tid; ?>
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NHP SecureLocker</title>
  <style>
    :root{ --p:<?= brand.primary ?>; --s:<?= brand.secondary ?>; --a:<?= brand.accent ?>; --t:<?= brand.text ?>; --t2:<?= brand.text2 ?>; --bg:<?= brand.bg ?>; --bd:<?= brand.border ?>; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP',sans-serif;background:var(--bg);color:var(--t);margin:0;padding:24px}
    .card{max-width:720px;margin:0 auto;background:#fff;border:1px solid var(--bd);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:24px}
    h1{font-size:22px;margin:0 0 8px}
    label{display:block;margin-top:12px;font-weight:600}
    input{width:100%;padding:10px;border:1px solid var(--bd);border-radius:10px;font-size:14px}
    .btn{background:var(--p);color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:700;margin-top:12px;cursor:pointer}
    .hint{color:var(--t2);font-size:13px}
    .ok{color:#0a7b49}.err{color:#b91c1c}
    .list{margin-top:8px}
    a{color:var(--p)}
  </style>
</head>
<body>
  <div class="card">
    <h1>NHP AI セキュアLocker / NHP SecureLocker</h1>
    <p class="hint">受信したメールのリンクから来ましたか？ 以下で本人確認 → 復号します。<br>1) メールアドレス → OTP受信  2) OTP入力  3) パスワードで復号</p>

    <div id="step1">
      <label>あなたのメールアドレス（受信先と同じもの）</label>
      <input id="email" type="email" placeholder="you@example.com"/>
      <button class="btn" id="req">OTPを送信 / Send OTP</button>
      <div id="s1out" class="hint"></div>
    </div>

    <div id="step2" style="display:none">
      <label>OTP（6桁）</label>
      <input id="otp" maxlength="6"/>
      <button class="btn" id="ver">認証 / Verify</button>
      <div id="s2out" class="hint"></div>
    </div>

    <div id="step3" style="display:none">
      <label>パスワード（24桁）</label>
      <input id="pw" type="password"/>
      <button class="btn" id="dl">復号してダウンロード / Decrypt & Download</button>
      <div id="s3out" class="hint"></div>
      <div id="files" class="list"></div>
    </div>
  </div>

  <script>
    const tid = "<?= tid ?>";
    let sessionToken = ''; let files = [];

    document.getElementById('req').onclick = function(){
      const email = document.getElementById('email').value.trim();
      google.script.run.withSuccessHandler(res=>{
        const out = document.getElementById('s1out');
        if(res && res.ok){ out.innerHTML = '<span class="ok">OTPを送信しました。メールをご確認ください。</span>'; document.getElementById('step2').style.display='block'; }
        else{ out.innerHTML = '<span class="err">OTP送信に失敗: '+(res&&res.error||'')+'</span>'; }
      }).requestOtp(tid, email, '');
    };

    document.getElementById('ver').onclick = function(){
      const email = document.getElementById('email').value.trim();
      const code = document.getElementById('otp').value.trim();
      google.script.run.withSuccessHandler(res=>{
        const out = document.getElementById('s2out');
        if(res && res.ok){
          sessionToken = res.sessionToken || '';
          out.innerHTML = '<span class="ok">認証成功。続けてパスワードを入力してください。</span>';
          document.getElementById('step3').style.display='block';
          google.script.run.withSuccessHandler(p=>{
            if(p && p.ok){ files = p.files||[]; document.getElementById('files').innerHTML = files.map(f=>`<div>• ${f.name} (${(f.size/1024).toFixed(0)} KB)</div>`).join(''); }
          }).getPackage(tid, sessionToken);
        } else { out.innerHTML = '<span class="err">認証失敗: '+(res&&res.error||'')+'</span>'; }
      }).verifyOtp(tid, email, code);
    };

    document.getElementById('dl').onclick = function(){
      const pw = document.getElementById('pw').value;
      if(!pw){ document.getElementById('s3out').innerHTML='<span class="err">パスワードを入力してください。</span>'; return; }
      google.script.run.withSuccessHandler(p=>{
        if(!(p && p.ok)){ document.getElementById('s3out').innerHTML='<span class="err">取得失敗</span>'; return; }
        // v0.1：暗号化パッケージ(.yenc JSON)をそのままダウンロード（ブラウザ復号はv1系で追加）
        p.files.forEach(f=>{
          const a = document.createElement('a');
          a.href = 'data:application/json;base64,'+f.b64; a.download = f.name; a.click();
        });
        document.getElementById('s3out').innerHTML='<span class="ok">ダウンロードを開始しました。</span>';
      }).getPackage(tid, sessionToken);
    };
  </script>
</body>
</html>
